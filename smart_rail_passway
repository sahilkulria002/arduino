#include <ESP32Servo.h>

Servo myservo;
int ServoPin = 13;   // Safe pin
#define TRIG_PIN 2
#define ECHO_PIN 5
#define LED_PIN_R 4
#define LED_PIN_G 15  
#define TRIG2_PIN 22
#define ECHO2_PIN 21

// --- Adjustable filtering parameters ---
int totalReadings = 5;       // number of readings per check
int minDetections = 3;       // minimum number of "train detected" to confirm
float detectDistance = 10.0; // detection threshold (cm)
float clearDistance = 20.0;  // distance for "train gone"

void setup() {
  Serial.begin(115200);
  myservo.attach(ServoPin);
  myservo.write(90);
  Serial.println("Servo initialized at 90°");
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(LED_PIN_G, OUTPUT);
  pinMode(LED_PIN_R, OUTPUT);
  pinMode(TRIG2_PIN, OUTPUT);
  pinMode(ECHO2_PIN, INPUT);
  digitalWrite(LED_PIN_G, HIGH);
}

float getFilteredDistance(int trigPin, int echoPin) {
  int countDetected = 0;
  for (int i = 0; i < totalReadings; i++) {
    digitalWrite(trigPin, LOW);
    delayMicroseconds(2);
    digitalWrite(trigPin, HIGH);
    delayMicroseconds(10);
    digitalWrite(trigPin, LOW);
    long duration = pulseIn(echoPin, HIGH, 30000); // timeout 30ms
    float d = duration / 58.0;
    if (d > 0 && d < detectDistance) countDetected++;
    delay(10);
  }
  // If enough detections, return "detected" distance, else large value
  if (countDetected >= minDetections) return detectDistance - 1;
  else return 999; // means "no train"
}

void loop() {
  static int open = 1;
  static int s1 = 0;
  static int s2 = 0;
  static int trainDetected = 0;  // 0 = no train currently in system

  float distance = getFilteredDistance(TRIG_PIN, ECHO_PIN);
  float distance2 = getFilteredDistance(TRIG2_PIN, ECHO2_PIN);

  Serial.print("S1: "); Serial.print(distance);
  Serial.print(" cm  |  S2: "); Serial.print(distance2);
  Serial.println(" cm");

  // ---- 1️⃣ First detection (any side) ----
  if ((distance < detectDistance && s1 == 0 && trainDetected == 0) ||
      (distance2 < detectDistance && s2 == 0 && trainDetected == 0)) {

    // Close gate
    digitalWrite(LED_PIN_R, HIGH);
    digitalWrite(LED_PIN_G, LOW);
    for (int pos = 90; pos >= 0; pos -= 10) {
      myservo.write(pos);
      delay(200);
    }
    open = 0;
    trainDetected = 1;

    if (distance < detectDistance) { s1 = 1; s2 = 0; }
    else { s2 = 1; s1 = 0; }
  }

  // ---- 2️⃣ Second detection (opposite side) ----
  else if (trainDetected == 1 && open == 0) {
    if (s1 == 1 && distance2 < detectDistance) {
      for (int pos = 0; pos <= 90; pos += 10) {
        myservo.write(pos);
        delay(200);
      }
      digitalWrite(LED_PIN_G, HIGH);
      digitalWrite(LED_PIN_R, LOW);
      open = 1;
    }
    else if (s2 == 1 && distance < detectDistance) {
      for (int pos = 0; pos <= 90; pos += 10) {
        myservo.write(pos);
        delay(200);
      }
      digitalWrite(LED_PIN_G, HIGH);
      digitalWrite(LED_PIN_R, LOW);
      open = 1;
    }
  }

  // ---- 3️⃣ Reset only after train is gone ----
  if (trainDetected == 1 && distance > clearDistance && distance2 > clearDistance) {
    s1 = 0;
    s2 = 0;
    trainDetected = 0;
  }

  delay(100);
}
